{%- assign dir = page.gallery_dir | default: include.dir | default: '/assets/images' -%}
{%- if dir -%}

{%- comment -%}Rekursive Pfad-Filterung: alle Unterverzeichnisse einschließen{%- endcomment -%}
{%- assign gallery_thumbnails = "" | split: "" -%}
{%- assign target_dir_with_slash = dir | append: '/' -%}

{%- for f in site.static_files -%}
  {%- if f.extname == '.webp' -%}
    {%- assign filename = f.path | split: '/' | last -%}
    {%- if filename contains '_thumbnail' -%}
      {%- comment -%}Rekursiv: Prüfe ob der Pfad mit dem Zielverzeichnis BEGINNT (nicht exakt gleich){%- endcomment -%}
      {%- assign path_starts_with_dir = false -%}
      {%- assign path_length = f.path | size -%}
      {%- assign dir_length = target_dir_with_slash | size -%}
      {%- if path_length >= dir_length -%}
        {%- assign path_prefix = f.path | slice: 0, dir_length -%}
        {%- if path_prefix == target_dir_with_slash -%}
          {%- assign path_starts_with_dir = true -%}
        {%- endif -%}
      {%- endif -%}
      {%- if path_starts_with_dir -%}
        {%- assign gallery_thumbnails = gallery_thumbnails | push: f -%}
      {%- endif -%}
    {%- endif -%}
  {%- endif -%}
{%- endfor -%}

{%- assign gallery_thumbnails = gallery_thumbnails | uniq | sort: "path" -%}
{%- assign gallery_meta = site.data.gallery | default: empty -%}
{%- assign gallery_id = include.gallery_id | default: 'main' -%}

<style>
.db-gallery {
  margin: 2rem 0;
}

.db-gallery-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
  grid-auto-rows: 10px;
  gap: 8px;
  margin: 1rem 0;
}

@media (min-width: 480px) {
  .db-gallery-grid {
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 10px;
  }
}

@media (min-width: 768px) {
  .db-gallery-grid {
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    gap: 12px;
  }
}

@media (min-width: 1024px) {
  .db-gallery-grid {
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 15px;
  }
}

@media (min-width: 1400px) {
  .db-gallery-grid {
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 18px;
  }
}

.db-gallery-item {
  margin: 0;
  padding: 0;
  border: none;
  background: none;
}

.db-gallery-button {
  display: block;
  width: 100%;
  padding: 0;
  border: none;
  background: none;
  cursor: pointer;
  border-radius: 6px;
  overflow: hidden;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.db-gallery-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.db-gallery-thumb {
  width: 100%;
  height: auto;
  display: block;
  border-radius: 6px;
}

.db-gallery-thumb-caption {
  font-size: 0.75rem;
  color: #666;
  margin-top: 0.4rem;
  text-align: center;
  line-height: 1.2;
}

/* Lightbox */
.db-gallery-lightbox {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.92);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  padding: 1rem;
  box-sizing: border-box;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s ease, visibility 0.3s ease;
}

.db-gallery-lightbox.active {
  opacity: 1;
  visibility: visible;
}

.db-gallery-lightbox-content {
  max-width: 95vw;
  max-height: 95vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
}

.db-gallery-path {
  color: #bbb;
  font-size: 0.8rem;
  margin-bottom: 1rem;
  word-break: break-all;
  text-align: center;
  font-family: monospace;
}

.db-gallery-large {
  max-width: 100%;
  max-height: 75vh;
  object-fit: contain;
  border-radius: 8px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.4);
}

.db-gallery-title {
  color: #fff;
  font-size: 1.2rem;
  font-weight: bold;
  margin: 1rem 0 0.5rem 0;
  text-align: center;
}

.db-gallery-caption {
  color: #ddd;
  font-size: 1rem;
  margin-top: 0.5rem;
  text-align: center;
  max-width: 600px;
  line-height: 1.4;
}

.db-gallery-close {
  position: absolute;
  top: 2rem;
  right: 2rem;
  background: rgba(255,255,255,0.2);
  color: white;
  border: none;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  font-size: 1.5rem;
  cursor: pointer;
  transition: background 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  line-height: 1;
}

.db-gallery-close:hover {
  background: rgba(255,255,255,0.3);
}

.db-gallery-nav {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  background: rgba(255,255,255,0.2);
  color: white;
  border: none;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  font-size: 1.8rem;
  cursor: pointer;
  transition: background 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  line-height: 1;
}

.db-gallery-nav:hover {
  background: rgba(255,255,255,0.3);
}

.db-gallery-prev {
  left: 2rem;
}

.db-gallery-next {
  right: 2rem;
}

.db-gallery-lightbox-backdrop {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: -1;
}

@media (max-width: 768px) {
  .db-gallery-lightbox {
    padding: 0.5rem;
  }

  .db-gallery-close {
    top: 1rem;
    right: 1rem;
    width: 35px;
    height: 35px;
    font-size: 1.3rem;
  }

  .db-gallery-nav {
    width: 40px;
    height: 40px;
    font-size: 1.5rem;
  }

  .db-gallery-prev {
    left: 1rem;
  }

  .db-gallery-next {
    right: 1rem;
  }

  .db-gallery-large {
    max-height: 70vh;
  }

  .db-gallery-path {
    font-size: 0.7rem;
  }
}
</style>

<div id="gallery-{{ gallery_id }}" class="db-gallery">
    <div class="db-gallery-grid">
        {%- for f in gallery_thumbnails -%}
        {%- assign large_path = f.path | replace: '_thumbnail.webp', '.webp' -%}
        {%- assign meta = gallery_meta | where: "path", large_path | first -%}
        {%- assign meta_title = meta.title | default: '' -%}
        {%- assign meta_caption = meta.caption | default: '' -%}
        {%- assign thumb_href = f.path | relative_url -%}
        {%- assign large_href = large_path | relative_url -%}
        <figure class="db-gallery-item"
                data-index="{{ forloop.index0 }}"
                data-thumb="{{ thumb_href }}"
                data-large="{{ large_href }}"
                data-title="{{ meta_title | escape }}"
                data-caption="{{ meta_caption | escape }}"
                data-path-raw="{{ large_path }}">
            <button class="db-gallery-button" type="button" aria-label="Bild {{ forloop.index }} öffnen">
                <img class="db-gallery-thumb"
                     src="{{ thumb_href }}"
                     alt="{{ meta_title | default: f.name | escape }}"
                     loading="lazy"
                     decoding="async">
            </button>
            {%- if meta_caption and meta_caption != '' -%}
            <figcaption class="db-gallery-thumb-caption">{{ meta_caption | truncate: 50 }}</figcaption>
            {%- endif -%}
        </figure>
        {%- endfor -%}
    </div>

    <!-- Lightbox Overlay -->
    <div class="db-gallery-lightbox">
        <div class="db-gallery-lightbox-backdrop"></div>

        <button class="db-gallery-close" aria-label="Schließen">&times;</button>
        <button class="db-gallery-nav db-gallery-prev" aria-label="Vorheriges Bild">&#8249;</button>
        <button class="db-gallery-nav db-gallery-next" aria-label="Nächstes Bild">&#8250;</button>

        <div class="db-gallery-lightbox-content">
            <div class="db-gallery-path"></div>
            <img class="db-gallery-large" src="" alt="">
            <div class="db-gallery-title"></div>
            <div class="db-gallery-caption"></div>
        </div>
    </div>
</div>

<script>
(function () {
    const root = document.getElementById("gallery-{{ gallery_id }}");
    if (!root) return;

    const lightbox = root.querySelector(".db-gallery-lightbox");
    const imgLarge = root.querySelector(".db-gallery-large");
    const pathEl = root.querySelector(".db-gallery-path");
    const titleEl = root.querySelector(".db-gallery-title");
    const captionEl = root.querySelector(".db-gallery-caption");
    const btnClose = root.querySelector(".db-gallery-close");
    const btnPrev = root.querySelector(".db-gallery-prev");
    const btnNext = root.querySelector(".db-gallery-next");
    const backdrop = root.querySelector(".db-gallery-lightbox-backdrop");
    const items = Array.from(root.querySelectorAll(".db-gallery-item"));
    let currentIndex = -1;

    // Masonry layout für Thumbnails
    function layoutGrid() {
        const grid = root.querySelector(".db-gallery-grid");
        const gridItems = grid.querySelectorAll(".db-gallery-item");

        gridItems.forEach(item => {
            const img = item.querySelector("img");
            if (img.complete && img.naturalHeight > 0) {
                setSpan(item, img);
            } else {
                img.addEventListener('load', () => setSpan(item, img), { once: true });
            }
        });
    }

    function setSpan(item, img) {
        const height = img.offsetHeight;
        const gap = parseInt(getComputedStyle(item.parentElement).gap) || 10;
        const rowHeight = 10; // grid-auto-rows
        const span = Math.ceil((height + gap) / (rowHeight + gap));
        item.style.gridRowEnd = `span ${Math.max(span, 1)}`;
    }

    function openAt(index) {
        if (index < 0 || index >= items.length) return;
        currentIndex = index;
        const item = items[currentIndex];
        const large = item.dataset.large;
        const thumb = item.dataset.thumb;
        const title = item.dataset.title || "";
        const caption = item.dataset.caption || "";
        const displayPath = item.dataset.pathRaw || large;

        imgLarge.src = large;
        imgLarge.alt = title || "";
        pathEl.textContent = displayPath;
        titleEl.textContent = title;
        captionEl.textContent = caption;

        titleEl.style.display = title ? 'block' : 'none';
        captionEl.style.display = caption ? 'block' : 'none';

        // Fallback auf Thumbnail wenn Large-Version nicht existiert
        imgLarge.onerror = function () {
            if (imgLarge.src !== thumb) {
                imgLarge.src = thumb;
                pathEl.textContent = 'Fallback: ' + (item.dataset.pathRaw || thumb);
            }
        };

        lightbox.classList.add('active');
        document.body.style.overflow = 'hidden';
        btnClose.focus();
    }

    function close() {
        lightbox.classList.remove('active');
        document.body.style.overflow = '';
        currentIndex = -1;
    }

    function prev() {
        if (items.length) openAt(currentIndex <= 0 ? items.length - 1 : currentIndex - 1);
    }

    function next() {
        if (items.length) openAt(currentIndex >= items.length - 1 ? 0 : currentIndex + 1);
    }

    // Event Listeners
    items.forEach((item, i) => {
        item.querySelector(".db-gallery-button").addEventListener("click", () => openAt(i));
    });

    btnClose.addEventListener("click", close);
    btnPrev.addEventListener("click", prev);
    btnNext.addEventListener("click", next);
    backdrop.addEventListener("click", close);

    document.addEventListener("keydown", (ev) => {
        if (!lightbox.classList.contains('active')) return;
        if (ev.key === "Escape") { ev.preventDefault(); close(); }
        else if (ev.key === "ArrowLeft") { ev.preventDefault(); prev(); }
        else if (ev.key === "ArrowRight") { ev.preventDefault(); next(); }
    });

    // Layout initialisieren
    function initLayout() {
        layoutGrid();
        // Nochmal nach kurzer Zeit für sicherheit
        setTimeout(layoutGrid, 100);
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initLayout);
    } else {
        initLayout();
    }

    window.addEventListener('resize', layoutGrid);
})();
</script>

{%- else -%}
<div class="db-gallery-error">Bitte gallery_dir im Front Matter oder dir im Include setzen</div>
{%- endif -%}
