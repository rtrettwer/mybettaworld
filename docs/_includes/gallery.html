{%- assign dir = page.gallery_dir | default: include.dir | default: '/assets/images' -%}
{%- if dir -%}

{%- comment -%}Rekursive Pfad-Filterung: alle Unterverzeichnisse einschließen{%- endcomment -%}
{%- assign gallery_thumbnails = "" | split: "" -%}
{%- assign target_dir_with_slash = dir | append: '/' -%}

{%- for f in site.static_files -%}
  {%- if f.extname == '.webp' -%}
    {%- assign filename = f.path | split: '/' | last -%}
    {%- if filename contains '_thumbnail' -%}
      {%- comment -%}Rekursiv: Prüfe ob der Pfad mit dem Zielverzeichnis BEGINNT (nicht exakt gleich){%- endcomment -%}
      {%- assign path_starts_with_dir = false -%}
      {%- assign path_length = f.path | size -%}
      {%- assign dir_length = target_dir_with_slash | size -%}
      {%- if path_length >= dir_length -%}
        {%- assign path_prefix = f.path | slice: 0, dir_length -%}
        {%- if path_prefix == target_dir_with_slash -%}
          {%- assign path_starts_with_dir = true -%}
        {%- endif -%}
      {%- endif -%}
      {%- if path_starts_with_dir -%}
        {%- assign gallery_thumbnails = gallery_thumbnails | push: f -%}
      {%- endif -%}
    {%- endif -%}
  {%- endif -%}
{%- endfor -%}

{%- assign gallery_thumbnails = gallery_thumbnails | uniq | sort: "path" -%}
{%- assign gallery_meta = site.data.gallery | default: empty -%}
{%- assign gallery_id = include.gallery_id | default: 'main' -%}

<div id="gallery-{{ gallery_id }}" class="db-gallery">
    <div class="db-gallery-grid">
        {%- for f in gallery_thumbnails -%}
        {%- assign large_path = f.path | replace: '_thumbnail.webp', '.webp' -%}
        {%- assign meta = gallery_meta | where: "path", large_path | first -%}
        {%- assign meta_title = meta.title | default: '' -%}
        {%- assign meta_caption = meta.caption | default: '' -%}
        {%- assign thumb_href = f.path | relative_url -%}
        {%- assign large_href = large_path | relative_url -%}
        <figure class="db-gallery-item"
                data-index="{{ forloop.index0 }}"
                data-thumb="{{ thumb_href }}"
                data-large="{{ large_href }}"
                data-title="{{ meta_title | escape }}"
                data-caption="{{ meta_caption | escape }}"
                data-path-raw="{{ large_path }}">
            <button class="db-gallery-button" type="button" aria-label="Bild {{ forloop.index }} öffnen">
                <img class="db-gallery-thumb"
                     src="{{ thumb_href }}"
                     alt="{{ meta_title | default: f.name | escape }}"
                     loading="lazy"
                     decoding="async">
            </button>
            {%- if meta_caption and meta_caption != '' -%}
            <figcaption class="db-gallery-thumb-caption">{{ meta_caption | truncate: 50 }}</figcaption>
            {%- endif -%}
        </figure>
        {%- endfor -%}
    </div>

    <!-- Lightbox Overlay -->
    <div class="db-gallery-lightbox">
        <div class="db-gallery-lightbox-backdrop"></div>

        <button class="db-gallery-close" aria-label="Schließen">&times;</button>
        <button class="db-gallery-nav db-gallery-prev" aria-label="Vorheriges Bild">&#8249;</button>
        <button class="db-gallery-nav db-gallery-next" aria-label="Nächstes Bild">&#8250;</button>

        <div class="db-gallery-lightbox-content">
            <div class="db-gallery-path"></div>
            <img class="db-gallery-large" src="" alt="">
            <div class="db-gallery-title"></div>
            <div class="db-gallery-caption"></div>
        </div>
    </div>
</div>

<script>
(function () {
    const root = document.getElementById("gallery-{{ gallery_id }}");
    if (!root) return;

    const lightbox = root.querySelector(".db-gallery-lightbox");
    const imgLarge = root.querySelector(".db-gallery-large");
    const pathEl = root.querySelector(".db-gallery-path");
    const titleEl = root.querySelector(".db-gallery-title");
    const captionEl = root.querySelector(".db-gallery-caption");
    const btnClose = root.querySelector(".db-gallery-close");
    const btnPrev = root.querySelector(".db-gallery-prev");
    const btnNext = root.querySelector(".db-gallery-next");
    const backdrop = root.querySelector(".db-gallery-lightbox-backdrop");
    const items = Array.from(root.querySelectorAll(".db-gallery-item"));
    let currentIndex = -1;

    // CSS Columns Masonry Layout - automatische Verteilung
    function initMasonryLayout() {
        // Das CSS Grid mit den nth-child Selektoren regelt bereits die Spans
        // Hier nur sicherstellen, dass Bilder geladen sind
        items.forEach((item) => {
            const img = item.querySelector("img");
            if (!img.complete) {
                img.addEventListener('load', () => {
                    // Trigger eines Layout-Updates nach dem Laden
                    item.style.display = 'none';
                    item.offsetHeight; // Force reflow
                    item.style.display = 'block';
                }, { once: true });
            }
        });
    }

    function openAt(index) {
        if (index < 0 || index >= items.length) return;
        currentIndex = index;
        const item = items[currentIndex];
        const large = item.dataset.large;
        const thumb = item.dataset.thumb;
        const title = item.dataset.title || "";
        const caption = item.dataset.caption || "";
        const displayPath = item.dataset.pathRaw || large;

        imgLarge.src = large;
        imgLarge.alt = title || "";
        pathEl.textContent = displayPath;
        titleEl.textContent = title;
        captionEl.textContent = caption;

        titleEl.style.display = title ? 'block' : 'none';
        captionEl.style.display = caption ? 'block' : 'none';

        // Fallback auf Thumbnail wenn Large-Version nicht existiert
        imgLarge.onerror = function () {
            if (imgLarge.src !== thumb) {
                imgLarge.src = thumb;
                pathEl.textContent = 'Fallback: ' + (item.dataset.pathRaw || thumb);
            }
        };

        lightbox.classList.add('active');
        document.body.style.overflow = 'hidden';
        btnClose.focus();
    }

    function close() {
        lightbox.classList.remove('active');
        document.body.style.overflow = '';
        currentIndex = -1;
    }

    function prev() {
        if (items.length) openAt(currentIndex <= 0 ? items.length - 1 : currentIndex - 1);
    }

    function next() {
        if (items.length) openAt(currentIndex >= items.length - 1 ? 0 : currentIndex + 1);
    }

    // Event Listeners
    items.forEach((item, i) => {
        item.querySelector(".db-gallery-button").addEventListener("click", () => openAt(i));
    });

    btnClose.addEventListener("click", close);
    btnPrev.addEventListener("click", prev);
    btnNext.addEventListener("click", next);
    backdrop.addEventListener("click", close);

    document.addEventListener("keydown", (ev) => {
        if (!lightbox.classList.contains('active')) return;

        switch (ev.key) {
            case 'Escape':
                close();
                break;
            case 'ArrowLeft':
                ev.preventDefault();
                prev();
                break;
            case 'ArrowRight':
                ev.preventDefault();
                next();
                break;
        }
    });

    // Touch-Unterstützung für mobile Geräte
    let touchStartX = 0;
    let touchStartY = 0;

    lightbox.addEventListener('touchstart', (e) => {
        touchStartX = e.touches[0].clientX;
        touchStartY = e.touches[0].clientY;
    }, { passive: true });

    lightbox.addEventListener('touchend', (e) => {
        if (!lightbox.classList.contains('active')) return;

        const touchEndX = e.changedTouches[0].clientX;
        const touchEndY = e.changedTouches[0].clientY;
        const diffX = touchStartX - touchEndX;
        const diffY = touchStartY - touchEndY;

        // Horizontale Swipes für Navigation
        if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
            if (diffX > 0) {
                next(); // Swipe links = nächstes Bild
            } else {
                prev(); // Swipe rechts = vorheriges Bild
            }
        }
        // Vertikale Swipes zum Schließen
        else if (Math.abs(diffY) > 100 && Math.abs(diffY) > Math.abs(diffX)) {
            close();
        }
    }, { passive: true });

    // Layout beim Laden und bei Fenstergrößenänderung initialisieren
    initMasonryLayout();

    window.addEventListener('resize', () => {
        setTimeout(initMasonryLayout, 100);
    });
})();
</script>

{%- else -%}
<div class="db-gallery-error">Bitte gallery_dir im Front Matter oder dir im Include setzen</div>
{%- endif -%}
